# Таблица разделов версии 2

Во второй версии схема разделов переработана: добавлен раздел `assets` для загружаемых из сети материалов и оптимизированы размеры разделов под разные объёмы флеша.

## Основные изменения относительно v1

### Ключевые улучшения
1. **Новый раздел Assets**: выделен раздел `assets` под ресурсы, которые можно загрузить из сети.
2. **Замена раздела Model**: прежний `model` (960 КБ) заменён более вместительным `assets`.
3. **Оптимизация приложений**: размеры OTA‑разделов уменьшены, чтобы освободить место под ресурсы.
4. **Гибкость**: контент можно обновлять динамически без перепрошивки прошивки.

### Что хранится в разделе Assets
`assets` включает:
- **Модели активационных слов**: кастомные wake word модели, загружаемые по сети.
- **Темы и оформление**:
  - Шрифты (текстовые и иконковые)
  - Аудиоэффекты и звуки
  - Фоновые изображения и элементы UI
  - Наборы эмодзи
  - Языковые конфигурации
- **Динамический контент**: все ресурсы можно обновлять OTA через HTTP.

## Сравнение раскладок

### Схема v1 (16 МБ)
- `nvs`: 16 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `model`: 960 КБ
- `ota_0`: 6 МБ
- `ota_1`: 6 МБ

### Схема v2 (16 МБ)
- `nvs`: 16 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `ota_0`: 4 МБ
- `ota_1`: 4 МБ
- `assets`: 8 МБ

## Доступные конфигурации

### Устройства с 8 МБ флеша (`8m.csv`)
- `nvs`: 16 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `ota_0`: 3 МБ
- `ota_1`: 3 МБ
- `assets`: 2 МБ

### Устройства с 16 МБ (`16m.csv`) — стандарт
- `nvs`: 16 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `ota_0`: 4 МБ
- `ota_1`: 4 МБ
- `assets`: 8 МБ

### Устройства с 16 МБ (`16m_c3.csv`) — оптимизация для ESP32-C3
- `nvs`: 16 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `ota_0`: 4 МБ
- `ota_1`: 4 МБ
- `assets`: 4 МБ (≈4000 КБ, ограничение по количеству mmap‑страниц)

### Устройства с 32 МБ (`32m.csv`)
- `nvsfactory`: 200 КБ
- `nvs`: 840 КБ
- `otadata`: 8 КБ
- `phy_init`: 4 КБ
- `ota_0`: 4 МБ
- `ota_1`: 4 МБ
- `assets`: 16 МБ

## Преимущества

1. **Динамическое управление контентом**: обновление моделей, тем и прочих ресурсов без перепрошивки.
2. **Сокращённый размер приложений**: оптимизированные OTA‑разделы освобождают место под данные.
3. **Гибкая кастомизация**: поддержка пользовательских тем, wake word и языковых паков.
4. **Независимые обновления**: ресурсы можно менять отдельно от основной прошивки.
5. **Эффективное использование флеша**: конфигурируемый объём `assets` под разные устройства.
6. **OTA‑обновления ресурсов**: загрузка через HTTP с устройства.

## Технические детали

- **Тип раздела**: `assets` использует подтип `spiffs`, совместимый с файловой системой SPIFFS.
- **Память**: ресурсы memory-mapped для быстрого доступа во время работы.
- **Контроль целостности**: встроенная проверка чексумм.
- **Постепенная загрузка**: поддержка прогрессивного скачивания с индикацией прогресса.
- **Fallback**: возврат к дефолтным ресурсам при сбое обновления.

## Переход с v1

1. **Сделайте резервную копию** данных из старого раздела `model`.
2. **Залейте новую таблицу разделов** с подходящей v2‑конфигурацией.
3. **Загрузите ресурсы** — при первом запуске устройство скачает их автоматически.
4. **Проверьте функциональность** после миграции.

## Дополнительные замечания

- Размер `assets` зависит от выбранной таблицы, чтобы лучше вписаться в доступный флеш.
- На ESP32-C3 раздел ресурсов ограничен 4 МБ из-за числа mmap‑страниц.
- На 32‑мегабайтных платах доступно до 16 МБ под контент.
- Все таблицы соблюдают выравнивание для оптимальной работы флеша.

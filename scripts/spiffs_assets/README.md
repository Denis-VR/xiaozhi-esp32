# Конструктор SPIFFS‑ресурсов

Скрипт собирает ресурсовый раздел SPIFFS для проектов ESP32 и упаковывает различные файлы в формат, пригодный для устройства.

## Возможности

- Обработка моделей WakeNet (wake word)
- Интеграция текстовых шрифтов
- Импорт наборов эмодзи
- Автоматическая генерация индекса ресурсов
- Выпуск финального файла `assets.bin`

## Требования

- Python 3.6+
- Исходные файлы ресурсов

## Использование

### Базовый синтаксис

```bash
./build.py --wakenet_model <путь_к_модели> \
    --text_font <файл_шрифта> \
    --emoji_collection <каталог_эмодзи>
```

### Параметры

| Параметр | Тип | Обязателен | Описание |
|----------|-----|------------|----------|
| `--wakenet_model` | каталог | Нет | Папка с моделью WakeNet |
| `--text_font` | файл | Нет | Бинарный файл шрифта |
| `--emoji_collection` | каталог | Нет | Директория с изображениями эмодзи |

### Примеры

```bash
# Полный набор параметров
./build.py \
    --wakenet_model ../../managed_components/espressif__esp-sr/model/wakenet_model/wn9_nihaoxiaozhi_tts \
    --text_font ../../components/xiaozhi-fonts/build/font_puhui_common_20_4.bin \
    --emoji_collection ../../components/xiaozhi-fonts/build/emojis_64/

# Только шрифт
./build.py --text_font ../../components/xiaozhi-fonts/build/font_puhui_common_20_4.bin

# Только эмодзи
./build.py --emoji_collection ../../components/xiaozhi-fonts/build/emojis_64/
```

## Рабочий процесс

1. **Создание структуры сборки**
   - `build/` — корень
   - `build/assets/` — каталог ресурсов
   - `build/output/` — промежуточные результаты

2. **Обработка модели WakeNet**
   - Копирование файлов модели
   - Запуск `pack_model.py` для генерации `srmodels.bin`
   - Перенос итоговой модели в `assets`

3. **Обработка шрифтов**
   - Копирование `.bin` шрифта в каталог ресурсов

4. **Обработка набора эмодзи**
   - Сканирование каталога картинок
   - Поддержка `.png` и `.gif`
   - Автогенерация индекса эмодзи

5. **Генерация конфигурации**
   - `index.json` — индекс ресурсов
   - `config.json` — параметры сборки

6. **Финальная упаковка**
   - `spiffs_assets_gen.py` формирует `assets.bin`
   - Файл копируется в корень `build/`

## Результат

После выполнения в `build/` появляются:

- `assets/` — подготовленные ресурсы
- `assets.bin` — готовый SPIFFS‑образ
- `config.json` — конфигурация сборки
- `output/` — промежуточные файлы

## Поддерживаемые форматы

- **Модели**: `.bin` (после `pack_model.py`)
- **Шрифты**: `.bin`
- **Изображения**: `.png`, `.gif`
- **Конфигурации**: `.json`

## Обработка ошибок

Скрипт проверяет:

- Наличие исходных файлов и каталогов
- Статус выполнения подпроцессов
- Выводит понятные ошибки и предупреждения

## Важные замечания

1. Все зависимые Python‑скрипты должны находиться рядом.
2. Пути к ресурсам используйте абсолютные или относительные от каталога скрипта.
3. Перед сборкой предыдущие артефакты очищаются.
4. Размер `assets.bin` ограничен размером SPIFFS‑раздела.
